services:
  ai-worker:
    build:
      context: .
      dockerfile: src/ai_worker/Dockerfile
      # Enable BuildKit (use cache mount)
      # Set cache path to persistent directory (persists across reboots)
      x-bake:
        cache-from:
          - type=local,src=C:/Docker/buildx-cache
        cache-to:
          - type=local,dest=C:/Docker/buildx-cache
    env_file:
      - .env
    volumes:
      - ./src:/app/src  # (Optional) Mount for immediate code changes
      - huggingface-cache:/root/.cache/huggingface  # Persistent model cache storage (prevents redownload on rebuild)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    # Comment out the deploy section above if no GPU or not configured.
    restart: on-failure:3  # Restart max 3 times on failure
    stop_grace_period: 30s
    init: true

# Named volumes for persistent storage
volumes:
  huggingface-cache:
    # Persistent volume for HuggingFace model cache
    # Windows location: Docker Desktop -> Settings -> Resources -> Disk image location
    # Approx 20-30GB disk space required (Qwen2.5-7B = ~15GB)
